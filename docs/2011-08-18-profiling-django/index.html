<!DOCTYPE html>
<html lang="en">
<head>
<!-- Last built: 2021-12-05T00:21:38+00:00 -->
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Andy McKay :: Profiling Django</title>
<link href="/css/style.css?v=2021-12-05T00:21:38+00:00" rel="stylesheet" type="text/css">
<link href="/css/pygments.css?v=2021-12-05T00:21:38+00:00" rel="stylesheet" type="text/css">
<link rel="shortcut icon" type="image/ico" href="/images/favicon.ico" />
<link rel="alternate" href="/atom.xml" type="application/atom+xml">
<meta name="viewport" content="initial-scale=1, maximum-scale=1">
</head>
<body>
<div id="main">
<header>
  <h1><a href="/">Andy McKay</a></h1>
</header>
<section>
<article>
<div class="meta">Aug 18, 2011</div>
<h2><a href="/2011-08-18-profiling-django/">Profiling Django</a></h2>
<hr class="florished">
<p>At the recent <a href="https://mckay.pub.ca/blog/andy/2306/">WebDev offsite</a> in Portland, we had a chance to spend the day working on any project we wanted and then show the results off that afternoon. I chose to play around with <a href="http://socket.io/">Socket IO</a>. This is also inspired by a great talk by <a href="http://blog.abourget.net/2011/3/09/new-and-hot-stuff-in-the-pylons-project/">Alexander Bourget at Confoo</a>.</p>
<p>A while back I was trying to profile my Django site and find some speed improvements. I started off by looking for a nice way to profile a Django site and give me some output. That's easy, as it turns out there's some code in <a href="https://github.com/django-extensions/django-extensions">Django command extensions</a> that outputs profiles:</p>
<pre>python manage.py runprofileserver --use-cprofile --prof-path=/tmp/output</pre>
<p>For each request to your Django site this will output in <code>cprofile</code> format a profile of the request, one per file. Now we just need a tool to read it.</p>
<p>When Googling this the main blog posts I found covered a format called <code>kcachegrind</code>, which is used by a tool to output some useful information. Unfortunately on a Mac this means using X Windows, Mac ports and a whole pile of stuff. There's <a href="http://www.maccallgrind.com/">MacCallGrind</a>, but that didn't work, just hung. So that's where I started writing something.</p>
<p><a href="https://github.com/andymckay/talisker">Talisker</a> is a Socket IO based server using <a href="http://www.gevent.org/">gevent</a> and <a href="https://www.pylonsproject.org/">Pyramid</a>. It's a stand alone Pyramid app that you can start up and then open in your browser. It will scan a directory and collect all profiles in that directory ready to send back to the client when messages come in. So we get something like this:</p>
<p><img src="/files/talisker/graph.png" /></p>
<p>You can see a nice graph of the directories. Since this is Socket IO and using <a href="http://code.google.com/p/flot/">Flot</a>, it will update automatically and show you time the requests took in real time. Woo.</p>
<p>Because it's using cprofile, we can parse the profiles with the <a href="http://docs.python.org/library/profile.html">Python pstats</a> module. Which awesomely has this line in it:</p>
<pre># Class for printing reports on profiled python code. rev 1.0  4/1/94</pre>
<p>From 1994, that's some vintage. Pstats has the nice ability to group multiple profiles together, so we can group together all the requests to /random on my Django site and get some stats for all the pages. Because this is just a table, I added a JS table sorted on to that. Being able to sort the stats is nice too:</p>
<p><img src="/files/talisker/ordered.png" /></p>
<p>You could also view each request individually if you wanted to see just one slow request. This
will let you home in on an element like this:</p>
<p><img src="/files/talisker/random.png" /></p>
<p>And then clicking on that will give you the line of the source:</p>
<p><img src="/files/talisker/source.png" /></p>
<p>And sure enough you can see the problem.</p>
<p>Previously I'd found the output of the runprofileserver simple and useful. So I'd decided to write a Nose plugin. <a href="https://github.com/andymckay/nose-talisker/commits/master">Talisker Nose</a> is a plugin that you can run whilst running your unit tests and it will output to the same file format and can be parsed by Talisker. Sadly, this kind of ruins the graph display. But it can be useful for finding what happens in the tests.</p>
<p>This is of course an app written quickly, chances are if you try it, it won't work. But it's something that I didn't find a nice solution for in the Python world and something that I would like to improve without resorting to the old fashioned native apps. There's no need for that anymore. Or perhaps Tarek will <a href="http://tarekziade.wordpress.com/2011/08/08/afpy-camp-wrapup-redbarrel-pistil-0mq/">write it for us</a>.</p>

<div id="navigation">
  <a href="/2011-08-06-laffer-curve-and-50p/">&laquo; older</a>
  <a href="/2011-08-27-hst-voting-and-income/">newer &raquo;</a>
</div>

</article>
</section>
<footer>
<div id="thefooter">
  <p>
    <a href="/">Home</a> &bull;
    <a href="/archives/">Archives</a>
  </p>
  <p>
    I work at <a href="https://github.com">GitHub</a>. I used to be at <a href="https://www.mozilla.com">Mozilla</a>.<br />
    <a href="mailto:andy@mckay.pub">andy@mckay.pub</a> &bull;
    <a href="https://mckay.pub.ca/atom.xml">RSS</a><br />
    <a href="https://twitter.com/andymckay">Twitter</a> &bull;
    <a href="https://www.linkedin.com/pub/andy-mckay/11/225/aa1">Linkedin</a> &bull;
    <a href="https://github.com/andymckay">GitHub</a><br />
  </p>
</div>
</footer>
</div>
</body>
</html>
